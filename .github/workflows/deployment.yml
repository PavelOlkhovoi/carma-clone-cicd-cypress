name: Deploy to GitHub Pages

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      has_e2e:    ${{ steps.check_e2e.outputs.has_e2e }}
      e2e_projects: ${{ steps.check_e2e.outputs.e2e_projects }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Update submodules
        run: git submodule update --remote --recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Install Nx globally
        run: npm install -g nx

      - name: Extract branch name
        id: extract_branch
        shell: bash
        run: |
          echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT

      - name: Derive appropriate SHAs for base and head for `nx affected`
        id: setSHAs
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: ${{ steps.extract_branch.outputs.branch }}

      - name: Print SHAs
        run: |
          echo "BASE: ${{ steps.setSHAs.outputs.base }}"
          echo "HEAD: ${{ steps.setSHAs.outputs.head }}"

      - name: Check for E2E changes
        id: check_e2e
        shell: bash
        run: |
          # List all affected e2e projects between base and head
          projects=$(npx nx show projects --affected --target=e2e \
            --base=${{ steps.setSHAs.outputs.base }} \
            --head=${{ steps.setSHAs.outputs.head }})

          if [ -n "$projects" ]; then
            echo "has_e2e=true" >> $GITHUB_OUTPUT
            # Normalize into a JSON array: ["proj1","proj2",â€¦]
            arr=$(echo $projects | tr ' ' ',' | sed 's/^/[\"/; s/$/\"]/; s/,/\",\"/g')
            echo "e2e_projects=$arr" >> $GITHUB_OUTPUT
          else
            echo "has_e2e=false"  >> $GITHUB_OUTPUT
            echo "e2e_projects=[]" >> $GITHUB_OUTPUT
          fi
